# 공공API로직

> Author. BAEKJH

## 공공데이터포털

> 참고 : https://www.data.go.kr/

## 로직

- `공공API를 가져온다.`
    - 공공데이터를 가져올 때, dataType을 JSON으로 할지 XML로 할지 정한다.
    - 데이터를 파일로 떨굴지, DB에 저장해놓고 읽어올지 정한다.
    - 파일로 떨굴 경우 비동기방식으로 처리
    - DB에 저장해놓는 경우에는, 쿼리를 호출하므로 메인페이지로딩시간이 3초 이내여야 하는데, 공공데이터를 늦게 가져오거나 그럴경우 취약점에 걸린다.

- `가져온API를 파일로 떨군다`
    - 어떤 형식의 파일로 떨굴지 정한다.(JSON OR XML)
        - JSON 추천
            - 이유 : JSON 데이터가 XML 데이터보다 더 빨리 읽고 쓸 수 있다.
    - 파일로 떨구기 위해 가져온 데이터를 DTO 객체로 변환한다.
    - DTO를 JSON 형식의 문자열로 변환한다.
    - JSON 형식의 문자열을 메서드에서 파라미터로 받아, JSON 파일을 생성한다.
    - DTO 객체에 `updateAt`이라는 속성(필드)을 추가해서 파일 하나로 관리할 수 있게끔 한다.
        - 수정일을 통해 언제 최신화 되었는지 알 수 있다.
        - 또한, JSP 화면에 년, 월, 일, 요일 등이 필요 할 수 있으므로, dto에 속성을 추가한다.
        - 파일 생성 메서드가 호출되면, 전에 있던 파일을 덮어쓴다.

- `스케줄러로 등록을 한다`
    - 스케줄러로 등록하는 이유
        - Controller를 타는 경우, 해당 페이지가 로드될때마다 실행되므로 비효율적이다.
        - 공공데이터가 갱신될 때마다 가져오기만 하면된다.
    - 공공데이터가 갱신되는 시간을 `@Scheduled`에 설정한다.
    - 날씨와 미세먼지를 같이 가져오는 경우, 갱신 시간이 다르므로 `@Scheduled`이 적용된 메서드를 2개 생성한다.
    - `@Scheduled`를 사용하기 위해서 Application.class에서 `@EnableScheduling`을 적용시킨다. (스프링 부트 기준)

- `비동기 방식으로 파일을 읽어서 뿌린다`
    - JSON 파일을 읽기 위한 방법
        - `$.getJSON("파일이 저장된경로 webapp은 생략가능")`을 사용한다.
        - 주로 파일은 webapp 밑에 폴더를 생성해서 저장한다.
    - 자바스크립트와 제이쿼리로 비동기 처리

- `오류가 발생할 수 있는 경우의 수를 적고, 로직을 구현한다`
    - 자바스크립트에서 `console.log()`를 사용하여 오류에 대한 메세지 처리
        - console.error() 사용가능
        - throw new Error('날씨 에러'); 사용가능
    - 날씨와, 미세먼지 비동기 처리 로직에 대해서, 한 로직 내부에서 발생 할 수있는 오류의 수가 많으므로, 로직을 실행하다가 어떠한 오류라도 발생시 try catch 구문을 사용하여 catch 구문에서 오류 처리 
        - console.error(e)

## 공공API를 가져오는 방식

- ServiceKey를 발급받아서 `EndPoint`와 `필수속성`과 값을 쿼리파라미터 형태로 지정하여 URI를 만들어서 `URL 클래스를 통해 객체로 생성`하여 `BufferedReader`와 `url.openStream()`을 이용하여 공공 API 데이터를 가져온다.

## 특징

- 동네예보정보조회서비스(날씨)의 경우는 API를 받아올 때, JSON과 XML 둘 다 지원

- 대기오염정보조회서비스(미세먼지)의 경우는 API를 받아올 때, XML 형식만 지원
    - BUT 워드 문서를 자세히 보면 JSON도 지원하는거 같음



